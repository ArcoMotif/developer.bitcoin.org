

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Payment Processing &mdash; Bitcoin  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="P2P Network" href="p2p_networking.html" />
    <link rel="prev" title="Transactions" href="transactions.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/bitcoin-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../devguide/index.html">Developer Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">Testing Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="transactions.html">Transactions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Payment Processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#payment-protocol">Payment Protocol</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#paymentrequest-paymentdetails">PaymentRequest &amp; PaymentDetails</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="p2p_networking.html">P2P Network</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Bitcoin</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Examples</a> &raquo;</li>
        
      <li>Payment Processing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/cornelius/bitcoin-dev-docs/blob/master/examples/payment_processing.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="payment-processing">
<h1>Payment Processing<a class="headerlink" href="#payment-processing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="payment-protocol">
<h2>Payment Protocol<a class="headerlink" href="#payment-protocol" title="Permalink to this headline">¶</a></h2>
<p>To request payment using the payment protocol, you use an extended (but backwards-compatible) <a class="reference external" href="/en/developer-guide#term-bitcoin-uri">“bitcoin:” URI</a>. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>bitcoin:mjSk1Ny9spzU2fouzYgLqGUD8U41iR35QN\
?amount=0.10\
&amp;label=Example+Merchant\
&amp;message=Order+of+flowers+%26+chocolates\
&amp;r=https://example.com/pay.php/invoice%3Dda39a3ee
</pre></div>
</div>
<p>The browser, QR code reader, or other program processing the URI opens the spender’s Bitcoin wallet program on the URI. If the wallet program is aware of the payment protocol, it accesses the URL specified in the <a class="reference external" href="/en/developer-guide#term-r-parameter">“r”</a> parameter, which should provide it with a serialized <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> served with the <a class="reference external" href="https://en.wikipedia.org/wiki/Internet_media_type">MIME</a> type <code class="docutils literal notranslate"><span class="pre">application/bitcoin-paymentrequest</span></code>.</p>
<p><strong>Resource:</strong> Gavin Andresen’s <a class="reference external" href="https://github.com/gavinandresen/paymentrequest/blob/master/php/demo_website/createpaymentrequest.php">Payment Request Generator</a> generates custom example URIs and payment requests for use with testnet.</p>
<div class="section" id="paymentrequest-paymentdetails">
<h3>PaymentRequest &amp; PaymentDetails<a class="headerlink" href="#paymentrequest-paymentdetails" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> is created with data structures built using Google’s <a class="reference external" href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a>. <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki">BIP70</a> describes these data structures in the non-sequential way they’re defined in the payment request <a class="reference external" href="https://developers.google.com/protocol-buffers/">protocol buffer</a> code, but the text below will describe them in a more linear order using a simple (but functional) Python CGI program. (For brevity and clarity, many normal CGI best practices are not used in this program.)</p>
<p>The full sequence of events is illustrated below, starting with the spender clicking a <a class="reference external" href="/en/developer-guide#term-bitcoin-uri">“bitcoin:” URI</a> or scanning a <code class="docutils literal notranslate"><span class="pre">bitcoin:</span></code> QR code.</p>
<div class="figure align-center" id="id1">
<img alt="BIP70 Payment Protocol" src="../_images/en-payment-protocol.svg" /><p class="caption"><span class="caption-text">BIP70 Payment Protocol</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>For the script to use the <a class="reference external" href="https://developers.google.com/protocol-buffers/">protocol buffer</a>, you will need a copy of Google’s <a class="reference external" href="https://developers.google.com/protocol-buffers/">Protocol Buffer</a> compiler (<code class="docutils literal notranslate"><span class="pre">protoc</span></code>), which is available in most modern Linux package managers and <a class="reference external" href="https://developers.google.com/protocol-buffers/">directly from Google.</a> Non-Google <a class="reference external" href="https://developers.google.com/protocol-buffers/">protocol buffer</a> compilers are available for a variety of programming languages. You will also need a copy of the <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> <a class="reference external" href="https://github.com/bitcoin/bitcoin/blob/master/src/qt/paymentrequest.proto">Protocol Buffer description</a> from the Bitcoin Core source code.</p>
<div class="section" id="initialization-code">
<h4>Initialization Code<a class="headerlink" href="#initialization-code" title="Permalink to this headline">¶</a></h4>
<p>With the Python code generated by <code class="docutils literal notranslate"><span class="pre">protoc</span></code>, we can start our simple CGI program.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1">## This is the code generated by protoc --python_out=./ [paymentrequest][paymentrequest].proto</span>
<span class="kn">from</span> <span class="nn">paymentrequest_pb2</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">## Load some functions</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">stdout</span>
<span class="kn">from</span> <span class="nn">OpenSSL.crypto</span> <span class="kn">import</span> <span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="n">load_privatekey</span><span class="p">,</span> <span class="n">sign</span>

<span class="c1">## Copy three of the classes created by protoc into objects we can use</span>
<span class="n">details</span> <span class="o">=</span> <span class="p">[</span><span class="n">PaymentDetails</span><span class="p">][</span><span class="n">paymentdetails</span><span class="p">]()</span>
<span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="n">PaymentRequest</span><span class="p">][</span><span class="n">paymentrequest</span><span class="p">]()</span>
<span class="n">x509</span> <span class="o">=</span> <span class="p">[</span><span class="n">X509Certificates</span><span class="p">][</span><span class="n">x509certificates</span><span class="p">]()</span>
</pre></div>
</div>
<p>The startup code above is quite simple, requiring nothing but the epoch (Unix date) time function, the standard out file descriptor, a few functions from the OpenSSL library, and the data structures and functions created by <code class="docutils literal notranslate"><span class="pre">protoc</span></code>.</p>
</div>
<div class="section" id="configuration-code">
<h4>Configuration Code<a class="headerlink" href="#configuration-code" title="Permalink to this headline">¶</a></h4>
<p>Next, we’ll set configuration settings which will typically only change when the receiver wants to do something differently. The code pushes a few settings into the <code class="docutils literal notranslate"><span class="pre">request</span></code> (<a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a>) and <code class="docutils literal notranslate"><span class="pre">details</span></code> (<a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a>) objects. When we serialize them, <a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a> will be contained within the <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## SSL Signature method</span>
<span class="n">request</span><span class="o">.</span><span class="n">pki_type</span> <span class="o">=</span> <span class="s2">&quot;x509+sha256&quot;</span>  <span class="c1">## Default: none</span>

<span class="c1">## Mainnet or testnet?</span>
<span class="n">details</span><span class="o">.</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">network</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>  <span class="c1">## Default: main</span>

<span class="c1">## Postback URL</span>
<span class="n">details</span><span class="o">.</span><span class="n">payment_url</span> <span class="o">=</span> <span class="s2">&quot;https://example.com/pay.py&quot;</span>

<span class="c1">## [PaymentDetails][paymentdetails] version number</span>
<span class="n">request</span><span class="o">.</span><span class="n">payment_details_version</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">## Default: 1</span>

<span class="c1">## [Certificate chain][certificate chain]</span>
<span class="n">x509</span><span class="o">.</span><span class="n">certificate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">(</span><span class="s2">&quot;/etc/apache2/example.com-cert.[der][der]&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="c1">#x509.certificate.append(file(&quot;/some/intermediate/cert.[der][der]&quot;, &quot;r&quot;).read())</span>

<span class="c1">## Load private SSL key into memory for signing later</span>
<span class="n">priv_key</span> <span class="o">=</span> <span class="s2">&quot;/etc/apache2/example.com-key.pem&quot;</span>
<span class="n">pw</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>  <span class="c1">## Key password</span>
<span class="n">private_key</span> <span class="o">=</span> <span class="n">load_privatekey</span><span class="p">(</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="nb">file</span><span class="p">(</span><span class="n">priv_key</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">pw</span><span class="p">)</span>
</pre></div>
</div>
<p>Each line is described below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">pki_type</span> <span class="o">=</span> <span class="s2">&quot;x509+sha256&quot;</span>  <span class="c1">## Default: none</span>
</pre></div>
</div>
<p><a class="reference external" href="/en/developer-examples#term-pp-pki-type">“pki_type”</a>: (optional) tell the receiving wallet program what <a class="reference external" href="/en/developer-examples#term-pki">Public-Key Infrastructure</a> (<a class="reference external" href="/en/developer-examples#term-pki">PKI</a>) type you’re using to cryptographically sign your <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> so that it can’t be modified by a <a class="reference external" href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle</a> attack.</p>
<p>If you don’t want to sign the <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a>, you can choose a <a class="reference external" href="/en/developer-examples#term-pp-pki-type">“pki_type”</a> of <code class="docutils literal notranslate"><span class="pre">none</span></code> (the default).</p>
<p>If you do choose the sign the <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a>, you currently have two options defined by <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki">BIP70</a>: <code class="docutils literal notranslate"><span class="pre">x509+sha1</span></code> and <code class="docutils literal notranslate"><span class="pre">x509+sha256</span></code>. Both options use the <a class="reference external" href="https://en.wikipedia.org/wiki/X.509">X.509</a> certificate system, the same system used for HTTP Secure (HTTPS). To use either option, you will need a certificate signed by a certificate authority or one of their intermediaries. (A self-signed certificate will not work.)</p>
<p>Each wallet program may choose which certificate authorities to trust, but it’s likely that they’ll trust whatever certificate authorities their operating system trusts. If the wallet program doesn’t have a full operating system, as might be the case for small hardware wallets, <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki">BIP70</a> suggests they use the <a class="reference external" href="https://www.mozilla.org/en-US/about/governance/policies/security-group/certs/">Mozilla Root Certificate Store</a>. In general, if a certificate works in your web browser when you connect to your webserver, it will work for your <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequests</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">details</span><span class="o">.</span><span class="p">[</span><span class="n">network</span><span class="p">][</span><span class="n">network</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>  <span class="c1">## Default: main</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">network</span></code>: (optional) tell the spender’s wallet program what Bitcoin <a class="reference external" href="/en/developer-guide#term-network">network</a> you’re using; <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki">BIP70</a> defines “main” for mainnet (actual payments) and “test” for testnet (like mainnet, but fake satoshis are used). If the wallet program doesn’t run on the <a class="reference external" href="/en/developer-guide#term-network">network</a> you indicate, it will reject the <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">details</span><span class="o">.</span><span class="n">payment_url</span> <span class="o">=</span> <span class="s2">&quot;https://example.com/pay.py&quot;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">payment_url</span></code>: (required) tell the spender’s wallet program where to send the Payment message (described later). This can be a static URL, as in this example, or a variable URL such as <code class="docutils literal notranslate"><span class="pre">https://example.com/pay.py?invoice=123.</span></code> It should usually be an HTTPS address to prevent <a class="reference external" href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle</a> attacks from modifying the message.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">payment_details_version</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">## Default: 1</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">payment_details_version</span></code>: (optional) tell the spender’s wallet program what version of the <a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a> you’re using. As of this writing, the only version is version 1.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## This is the pubkey/certificate corresponding to the private SSL key</span>
<span class="c1">## that we&#39;ll use to sign:</span>
<span class="n">x509</span><span class="o">.</span><span class="n">certificate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">(</span><span class="s2">&quot;/etc/apache2/example.com-cert.[der][der]&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">x509certificates</span></code>: (required for signed <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequests</a>) you must provide the public SSL key/certificate corresponding to the private SSL key you’ll use to sign the <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a>. The certificate must be in ASN.1/<a class="reference external" href="https://en.wikipedia.org/wiki/X.690#DER_encoding">DER format</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## If the pubkey/cert above didn&#39;t have the signature of a root</span>
<span class="c1">## certificate authority, we&#39;d then append the [intermediate certificate][intermediate certificate]</span>
<span class="c1">## which signed it:</span>
<span class="c1">#x509.certificate.append(file(&quot;/some/intermediate/cert.[der][der]&quot;, &quot;r&quot;).read())</span>
</pre></div>
</div>
<p>You must also provide any <a class="reference external" href="/en/developer-examples#term-intermediate-certificate">intermediate certificates</a> necessary to link your certificate to the <a class="reference external" href="/en/developer-examples#term-root-certificate">root certificate</a> of a certificate authority trusted by the spender’s software, such as a certificate from the Mozilla root store.</p>
<p>The certificates must be provided in a specific order—the same order used by Apache’s <code class="docutils literal notranslate"><span class="pre">SSLCertificateFile</span></code> directive and other server software. The figure below shows the <a class="reference external" href="/en/developer-examples#term-certificate-chain">certificate chain</a> of the www.bitcoin.org <a class="reference external" href="https://en.wikipedia.org/wiki/X.509">X.509</a> certificate and how each certificate (except the <a class="reference external" href="/en/developer-examples#term-root-certificate">root certificate</a>) would be loaded into the <a class="reference external" href="/en/developer-examples#term-x509certificates">X509Certificates</a> <a class="reference external" href="https://developers.google.com/protocol-buffers/">protocol buffer</a> message.</p>
<div class="figure align-center" id="id2">
<img alt="X509Certificates Loading Order" src="../_images/en-cert-order.svg" /><p class="caption"><span class="caption-text">X509Certificates Loading Order</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>To be specific, the first certificate provided must be the <a class="reference external" href="https://en.wikipedia.org/wiki/X.509">X.509</a> certificate corresponding to the private SSL key which will make the signature, called the <a class="reference external" href="/en/developer-examples#term-leaf-certificate">leaf certificate</a>. Any <a class="reference external" href="/en/developer-examples#term-intermediate-certificate">intermediate certificates</a> necessary to link that signed public SSL key to the <a class="reference external" href="/en/developer-examples#term-root-certificate">root certificate</a> (the certificate authority) are attached separately, with each certificate in <a class="reference external" href="https://en.wikipedia.org/wiki/X.690#DER_encoding">DER format</a> bearing the signature of the certificate that follows it all the way to (but not including) the <a class="reference external" href="/en/developer-examples#term-root-certificate">root certificate</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">priv_key</span> <span class="o">=</span> <span class="s2">&quot;/etc/apache2/example.com-key.pem&quot;</span>
<span class="n">pw</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>  <span class="c1">## Key password</span>
<span class="n">private_key</span> <span class="o">=</span> <span class="n">load_privatekey</span><span class="p">(</span><span class="n">FILETYPE_PEM</span><span class="p">,</span> <span class="nb">file</span><span class="p">(</span><span class="n">priv_key</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">pw</span><span class="p">)</span>
</pre></div>
</div>
<p>(Required for signed <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequests</a>) you will need a private SSL key in a format your SSL library supports (<a class="reference external" href="https://en.wikipedia.org/wiki/X.690#DER_encoding">DER format</a> is not required). In this program, we’ll load it from a PEM file. (Embedding your passphrase in your CGI code, as done here, is obviously a bad idea in real life.)</p>
<p>The private SSL key will not be transmitted with your request. We’re only loading it into memory here so we can use it to sign the request later.</p>
</div>
<div class="section" id="code-variables">
<h4>Code Variables<a class="headerlink" href="#code-variables" title="Permalink to this headline">¶</a></h4>
<p>Now let’s look at the variables your CGI program will likely set for each payment.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## Amount of the request</span>
<span class="n">amount</span> <span class="o">=</span> <span class="mi">10000000</span>  <span class="c1">## In satoshis</span>

<span class="c1">## P2PKH pubkey hash</span>
<span class="n">pubkey_hash</span> <span class="o">=</span> <span class="s2">&quot;2b14950b8d31620c6cc923c5408a701b1ec0a020&quot;</span>
<span class="c1">## P2PKH pubkey script entered as hex and converted to binary</span>
<span class="c1"># OP_DUP OP_HASH160 &lt;push 20 bytes&gt; &lt;pubKey hash&gt; OP_EQUALVERIFY OP_CHECKSIG</span>
<span class="c1">#   76       a9            14       &lt;pubKey hash&gt;        88          ac</span>
<span class="n">hex_script</span> <span class="o">=</span> <span class="s2">&quot;76&quot;</span> <span class="o">+</span> <span class="s2">&quot;a9&quot;</span> <span class="o">+</span> <span class="s2">&quot;14&quot;</span> <span class="o">+</span> <span class="n">pubkey_hash</span> <span class="o">+</span> <span class="s2">&quot;88&quot;</span> <span class="o">+</span> <span class="s2">&quot;ac&quot;</span>
<span class="n">serialized_script</span> <span class="o">=</span> <span class="n">hex_script</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;hex&quot;</span><span class="p">)</span>

<span class="c1">## Load amount and pubkey script into [PaymentDetails][paymentdetails]</span>
<span class="n">details</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span><span class="p">,</span> <span class="n">script</span> <span class="o">=</span> <span class="n">serialized_script</span><span class="p">)</span>

<span class="c1">## Memo to display to the spender</span>
<span class="n">details</span><span class="o">.</span><span class="n">memo</span> <span class="o">=</span> <span class="s2">&quot;Flowers &amp; chocolates&quot;</span>

<span class="c1">## Data which should be returned to you with the payment</span>
<span class="n">details</span><span class="o">.</span><span class="n">merchant_data</span> <span class="o">=</span> <span class="s2">&quot;Invoice #123&quot;</span>
</pre></div>
</div>
<p>Each line is described below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">amount</span> <span class="o">=</span> <span class="mi">10000000</span>  <span class="c1">## In satoshis (=100 mBTC)</span>
</pre></div>
</div>
<p><a class="reference external" href="/en/developer-examples#term-pp-amount">“amount”</a>: (optional) the <a class="reference external" href="/en/developer-examples#term-pp-amount">amount</a> you want the spender to pay. You’ll probably get this value from your shopping cart application or <a class="reference external" href="/en/developer-guide#term-fiat">fiat</a>-to-BTC exchange rate conversion tool. If you leave the amount blank, the wallet program will prompt the spender how much to pay (which can be useful for donations).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pubkey_hash</span> <span class="o">=</span> <span class="s2">&quot;2b14950b8d31620c6cc923c5408a701b1ec0a020&quot;</span>
<span class="c1"># OP_DUP OP_HASH160 &lt;push 20 bytes&gt; &lt;pubKey hash&gt; OP_EQUALVERIFY OP_CHECKSIG</span>
<span class="c1">#   76       a9            14       &lt;pubKey hash&gt;        88          ac</span>
<span class="n">hex_script</span> <span class="o">=</span> <span class="s2">&quot;76&quot;</span> <span class="o">+</span> <span class="s2">&quot;a9&quot;</span> <span class="o">+</span> <span class="s2">&quot;14&quot;</span> <span class="o">+</span> <span class="n">pubkey_hash</span> <span class="o">+</span> <span class="s2">&quot;88&quot;</span> <span class="o">+</span> <span class="s2">&quot;ac&quot;</span>
<span class="n">serialized_script</span> <span class="o">=</span> <span class="n">hex_script</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;hex&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference external" href="/en/developer-examples#term-pp-script">“script”</a>: (required) You must specify the pubkey script you want the spender to pay—any valid pubkey script is acceptable. In this example, we’ll request payment to a P2PKH pubkey script.</p>
<p>First we get a pubkey hash. The hash above is the hash form of the address used in the URI examples throughout this section, mjSk1Ny9spzU2fouzYgLqGUD8U41iR35QN.</p>
<p>Next, we plug that hash into the standard P2PKH pubkey script using hex, as illustrated by the code comments.</p>
<p>Finally, we convert the pubkey script from hex into its serialized form.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">details</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span><span class="p">,</span> <span class="n">script</span> <span class="o">=</span> <span class="n">serialized_script</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">outputs</span></code>: (required) add the pubkey script and (optional) amount to the <a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a> outputs array.</p>
<p>It’s possible to specify multiple <a class="reference external" href="/en/developer-examples#term-pp-script">“scripts”</a> and <code class="docutils literal notranslate"><span class="pre">amounts</span></code> as part of a <a class="reference external" href="/en/developer-guide#term-merge-avoidance">merge avoidance</a> strategy, described later in the <a class="reference external" href="/en/developer-guide#merge-avoidance">Merge Avoidance subsection</a>. However, effective <a class="reference external" href="/en/developer-guide#term-merge-avoidance">merge avoidance</a> is not possible under the base <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki">BIP70</a> rules in which the spender pays each <a class="reference external" href="/en/developer-examples#term-pp-script">“script”</a> the exact amount specified by its paired <a class="reference external" href="/en/developer-examples#term-pp-amount">“amount”</a>. If the amounts are omitted from all <a class="reference external" href="/en/developer-examples#term-pp-amount">“amount”</a>/<a class="reference external" href="/en/developer-examples#term-pp-script">“script”</a> pairs, the spender will be prompted to choose an amount to pay.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">details</span><span class="o">.</span><span class="n">memo</span> <span class="o">=</span> <span class="s2">&quot;Flowers &amp; chocolates&quot;</span>
</pre></div>
</div>
<p><a class="reference external" href="/en/developer-examples#term-pp-memo">“memo”</a>: (optional) add a memo which will be displayed to the spender as plain UTF-8 text. Embedded HTML or other markup will not be processed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">details</span><span class="o">.</span><span class="n">merchant_data</span> <span class="o">=</span> <span class="s2">&quot;Invoice #123&quot;</span>
</pre></div>
</div>
<p><a class="reference external" href="/en/developer-examples#term-pp-merchant-data">“merchant_data”</a>: (optional) add arbitrary data which should be sent back to the receiver when the invoice is paid. You can use this to track your invoices, although you can more reliably track payments by generating a <a class="reference external" href="/en/developer-guide#term-unique-address">unique address</a> for each payment and then tracking when it gets paid.</p>
<p>The <a class="reference external" href="/en/developer-examples#term-pp-memo">“memo”</a> field can be arbitrarily long, but if you make them too long, you’ll run into the 50,000 byte limit on the entire <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a>, which includes the often several kilobytes given over to storing the <a class="reference external" href="/en/developer-examples#term-certificate-chain">certificate chain</a>. As will be described in a later subsection, the <a class="reference external" href="/en/developer-examples#term-pp-memo">“memo”</a> field can be used by the spender after payment as part of a cryptographically-proven <a class="reference external" href="/en/developer-guide#term-receipt">receipt</a>.</p>
</div>
<div class="section" id="derivable-data">
<h4>Derivable Data<a class="headerlink" href="#derivable-data" title="Permalink to this headline">¶</a></h4>
<p>Next, let’s look at some information your CGI program can automatically derive.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">## Request creation time</span>
<span class="n">details</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="c1">## Current epoch (Unix) time</span>

<span class="c1">## Request expiration time</span>
<span class="n">details</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1">## 10 minutes from now</span>

<span class="c1">## [PaymentDetails][paymentdetails] is complete; serialize it and store it in [PaymentRequest][paymentrequest]</span>
<span class="n">request</span><span class="o">.</span><span class="n">serialized_payment_details</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>

<span class="c1">## Serialized [certificate chain][certificate chain]</span>
<span class="n">request</span><span class="o">.</span><span class="n">pki_data</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>

<span class="c1">## Initialize signature field so we can sign the full [PaymentRequest][paymentrequest]</span>
<span class="n">request</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<span class="c1">## Sign [PaymentRequest][paymentrequest]</span>
<span class="n">request</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span> <span class="s2">&quot;sha256&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Each line is described below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">details</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="c1">## Current epoch (Unix) time</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">time</span></code>: (required) <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequests</a> must indicate when they were created in number of seconds elapsed since 1970-01-01T00:00 UTC (<a class="reference external" href="https://en.wikipedia.org/wiki/Unix_time">Unix epoch time</a> format).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">details</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1">## 10 minutes from now</span>
</pre></div>
</div>
<p><a class="reference external" href="/en/developer-examples#term-pp-expires">“expires”</a>: (optional) the <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> may also set an <a class="reference external" href="/en/developer-examples#term-pp-expires">“expires”</a> time after which they’re no longer valid. You probably want to give receivers the ability to configure the expiration time delta; here we used the reasonable choice of 10 minutes. If this request is tied to an order total based on a <a class="reference external" href="/en/developer-guide#term-fiat">fiat</a>-to-satoshis exchange rate, you probably want to base this on a delta from the time you got the exchange rate.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">serialized_payment_details</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">serialized_payment_details</span></code>: (required) we’ve now set everything we need to create the <a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a>, so we’ll use the SerializeToString function from the <a class="reference external" href="https://developers.google.com/protocol-buffers/">protocol buffer</a> code to store the <a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a> in the appropriate field of the <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">pki_data</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pki_data</span></code>: (required for signed <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequests</a>) serialize the <a class="reference external" href="/en/developer-examples#term-certificate-chain">certificate chain</a> <a class="reference external" href="/en/developer-examples#term-pp-pki-data">PKI data</a> and store it in the <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
<p>We’ve filled out everything in the <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> except the signature, but before we sign it, we have to initialize the signature field by setting it to a zero-byte placeholder.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span> <span class="s2">&quot;sha256&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">signature</span></code>: (required for signed <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequests</a>) now we make the <a class="reference external" href="/en/developer-examples#term-ssl-signature">signature</a> by signing the completed and serialized <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a>. We’ll use the private key we stored in memory in the configuration section and the same hashing formula we specified in <a class="reference external" href="/en/developer-examples#term-pp-pki-type">“pki_type”</a> (sha256 in this case)</p>
</div>
<div class="section" id="output-code">
<h4>Output Code<a class="headerlink" href="#output-code" title="Permalink to this headline">¶</a></h4>
<p>Now that we have <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> all filled out, we can serialize it and send it along with the HTTP headers, as shown in the code below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span> <span class="s2">&quot;Content-Type: application/bitcoin-[paymentrequest][paymentrequest]&quot;</span>
<span class="k">print</span> <span class="s2">&quot;Content-Transfer-Encoding: binary&quot;</span>
<span class="k">print</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
<p>(Required) <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0071.mediawiki">BIP71</a> defines the content types for <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequests</a>, Payments, and PaymentACKs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">request</span></code>: (required) now, to finish, we just dump out the serialized <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> (which contains the serialized <a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a>). The serialized data is in binary, so we can’t use Python’s print() because it would add an extraneous newline.</p>
<p>The following screenshot shows how the authenticated <a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a> created by the program above appears in the GUI from Bitcoin Core 0.9.</p>
<div class="figure align-center" id="id3">
<img alt="Bitcoin Core Showing Validated Payment Request" src="../_images/en-btcc-payment-request.png" />
<p class="caption"><span class="caption-text">Bitcoin Core Showing Validated Payment Request</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="p2p_networking.html" class="btn btn-neutral float-right" title="P2P Network" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="transactions.html" class="btn btn-neutral float-left" title="Transactions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Bitcoin.org

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>