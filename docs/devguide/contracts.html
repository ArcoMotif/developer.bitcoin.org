

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Contracts &mdash; Bitcoin  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Wallets" href="wallets.html" />
    <link rel="prev" title="Transactions" href="transactions.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/bitcoin-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="block_chain.html">Block Chain</a></li>
<li class="toctree-l2"><a class="reference internal" href="transactions.html">Transactions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Contracts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#escrow-and-arbitration">Escrow And Arbitration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#micropayment-channel">Micropayment Channel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#coinjoin">CoinJoin</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="wallets.html">Wallets</a></li>
<li class="toctree-l2"><a class="reference internal" href="payment_processing.html">Payment Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="operating_modes.html">Operating Modes</a></li>
<li class="toctree-l2"><a class="reference internal" href="p2p_network.html">P2P Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="mining.html">Mining</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Bitcoin</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Developer Guides</a> &raquo;</li>
        
      <li>Contracts</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/cornelius/bitcoin-dev-docs/blob/master/devguide/contracts.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="contracts">
<h1>Contracts<a class="headerlink" href="#contracts" title="Permalink to this headline">¶</a></h1>
<p>Contracts are transactions which use the decentralized Bitcoin system to enforce financial agreements. Bitcoin contracts can often be crafted to minimize dependency on outside agents, such as the court system, which significantly decreases the risk of dealing with unknown entities in financial transactions.</p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The following subsections will describe a variety of Bitcoin contracts already in use. Because contracts deal with real people, not just transactions, they are framed below in story format.</p>
<p>Besides the contract types described below, many other contract types have been proposed. Several of them are collected on the <a class="reference external" href="https://en.bitcoin.it/wiki/Contracts">Contracts page</a> of the Bitcoin Wiki.</p>
</div>
<div class="section" id="escrow-and-arbitration">
<h2>Escrow And Arbitration<a class="headerlink" href="#escrow-and-arbitration" title="Permalink to this headline">¶</a></h2>
<p>Charlie-the-customer wants to buy a product from Bob-the-businessman, but neither of them trusts the other person, so they use a contract to help ensure Charlie gets his merchandise and Bob gets his payment.</p>
<p>A simple contract could say that Charlie will spend satoshis to an output which can only be spent if Charlie and Bob both sign the input spending it. That means Bob won’t get paid unless Charlie gets his merchandise, but Charlie can’t get the merchandise and keep his payment.</p>
<p>This simple contract isn’t much help if there’s a dispute, so Bob and Charlie enlist the help of Alice-the-arbitrator to create an <a class="reference external" href="../reference/glossary.html#escrow-contract">escrow contract</a>. Charlie spends his satoshis to an output which can only be spent if two of the three people sign the input. Now Charlie can pay Bob if everything is ok, Bob can <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> Charlie’s money if there’s a problem, or Alice can arbitrate and decide who should get the satoshis if there’s a dispute.</p>
<p>To create a multiple-signature (<a class="reference external" href="../reference/glossary.html#multisig">multisig</a>) output, they each give the others a public key. Then Bob creates the following <a class="reference external" href="../reference/glossary.html#p2sh-multisig">P2SH multisig</a> redeem script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OP_2</span> <span class="p">[</span><span class="n">A</span><span class="s1">&#39;s pubkey] [B&#39;</span><span class="n">s</span> <span class="n">pubkey</span><span class="p">]</span> <span class="p">[</span><span class="n">C</span><span class="s1">&#39;s pubkey] OP_3 OP_CHECKMULTISIG</span>
</pre></div>
</div>
<p>(Opcodes to push the public keys onto the stack are not shown.)</p>
<p><code class="docutils literal notranslate"><span class="pre">OP_2</span></code> and <code class="docutils literal notranslate"><span class="pre">OP_3</span></code> push the actual numbers 2 and 3 onto the stack. <code class="docutils literal notranslate"><span class="pre">OP_2</span></code> specifies that 2 signatures are required to sign; <code class="docutils literal notranslate"><span class="pre">OP_3</span></code> specifies that 3 public keys (unhashed) are being provided. This is a 2-of-3 multisig pubkey script, more generically called a m-of-n pubkey script (where <em>m</em> is the <em>minimum</em> matching signatures required and <em>n</em> in the <em>number</em> of public keys provided).</p>
<p>Bob gives the redeem script to Charlie, who checks to make sure his public key and Alice’s public key are included. Then he hashes the redeem script to create a P2SH redeem script and pays the satoshis to it. Bob sees the payment get added to the block chain and ships the merchandise.</p>
<p>Unfortunately, the merchandise gets slightly damaged in transit. Charlie wants a full <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a>, but Bob thinks a 10% <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> is sufficient. They turn to Alice to resolve the issue. Alice asks for photo evidence from Charlie along with a copy of the redeem script Bob created and Charlie checked.</p>
<p>After looking at the evidence, Alice thinks a 40% <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> is sufficient, so she creates and signs a transaction with two outputs, one that spends 60% of the satoshis to Bob’s public key and one that spends the remaining 40% to Charlie’s public key.</p>
<p>In the signature script Alice puts her signature and a copy of the unhashed serialized redeem script that Bob created. She gives a copy of the incomplete transaction to both Bob and Charlie. Either one of them can complete it by adding his signature to create the following signature script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OP_0</span> <span class="p">[</span><span class="n">A</span><span class="s1">&#39;s signature] [B&#39;</span><span class="n">s</span> <span class="ow">or</span> <span class="n">C</span><span class="s1">&#39;s signature] [serialized redeem script]</span>
</pre></div>
</div>
<p>(Opcodes to push the signatures and redeem script onto the stack are not shown. <code class="docutils literal notranslate"><span class="pre">OP_0</span></code> is a workaround for an off-by-one error in the original implementation which must be preserved for compatibility. Note that the signature script must provide signatures in the same order as the corresponding public keys appear in the redeem script. See the description in <a class="reference external" href="/en/developer-reference#term-op-checkmultisig">“OP_CHECKMULTISIG”</a> for details.)</p>
<p>When the transaction is broadcast to the <a class="reference external" href="/en/developer-guide#term-network">network</a>, each peer checks the signature script against the P2SH output Charlie previously paid, ensuring that the redeem script matches the redeem script hash previously provided. Then the redeem script is evaluated, with the two signatures being used as input data. Assuming the redeem script validates, the two transaction outputs show up in Bob’s and Charlie’s wallets as spendable balances.</p>
<p>However, if Alice created and signed a transaction neither of them would agree to, such as spending all the satoshis to herself, Bob and Charlie can find a new arbitrator and sign a transaction spending the satoshis to another 2-of-3 multisig redeem script hash, this one including a public key from that second arbitrator. This means that Bob and Charlie never need to worry about their arbitrator stealing their money.</p>
<p><strong>Resource:</strong> <a class="reference external" href="https://www.bitrated.com/">BitRated</a> provides a multisig arbitration service interface using HTML/JavaScript on a GNU AGPL-licensed website.</p>
</div>
<div class="section" id="micropayment-channel">
<h2>Micropayment Channel<a class="headerlink" href="#micropayment-channel" title="Permalink to this headline">¶</a></h2>
<p>Alice also works part time moderating forum posts for Bob. Every time someone posts to Bob’s busy forum, Alice skims the post to make sure it isn’t offensive or spam. Alas, Bob often forgets to pay her, so Alice demands to be paid immediately after each post she approves or rejects. Bob says he can’t do that because hundreds of small payments will cost him thousands of satoshis in transaction fees, so Alice suggests they use a <a class="reference external" href="/en/developer-guide#term-micropayment-channel">micropayment channel</a>.</p>
<p>Bob asks Alice for her public key and then creates two transactions. The first transaction pays 100 millibitcoins to a P2SH output whose 2-of-2 multisig redeem script requires signatures from both Alice and Bob. This is the bond transaction. Broadcasting this transaction would let Alice hold the millibitcoins hostage, so Bob keeps this transaction private for now and creates a second transaction.</p>
<p>The second transaction spends all of the first transaction’s millibitcoins (minus a transaction fee) back to Bob after a 24 hour delay enforced by locktime. This is the <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> transaction. Bob can’t sign the <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> transaction by himself, so he gives it to Alice to sign, as shown in the illustration below.</p>
<div class="figure" id="id1">
<img alt="Micropayment Channel Example" src="../_images/en-micropayment-channel.svg" /><p class="caption"><span class="caption-text">Micropayment Channel Example</span></p>
</div>
<p>Alice checks that the <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> transaction’s locktime is 24 hours in the future, signs it, and gives a copy of it back to Bob. She then asks Bob for the bond transaction and checks that the <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> transaction spends the output of the bond transaction. She can now broadcast the bond transaction to the <a class="reference external" href="/en/developer-guide#term-network">network</a> to ensure Bob has to wait for the time lock to expire before further spending his millibitcoins. Bob hasn’t actually spent anything so far, except possibly a small transaction fee, and he’ll be able to broadcast the <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> transaction in 24 hours for a full <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a>.</p>
<p>Now, when Alice does some work worth 1 millibitcoin, she asks Bob to create and sign a new version of the <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> transaction. Version two of the transaction spends 1 millibitcoin to Alice and the other 99 back to Bob; it does not have a locktime, so Alice can sign it and spend it whenever she wants. (But she doesn’t do that immediately.)</p>
<p>Alice and Bob repeat these work-and-pay steps until Alice finishes for the day, or until the time lock is about to expire. Alice signs the final version of the <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> transaction and broadcasts it, paying herself and refunding any remaining balance to Bob. The next day, when Alice starts work, they create a new <a class="reference external" href="/en/developer-guide#term-micropayment-channel">micropayment channel</a>.</p>
<p>If Alice fails to broadcast a version of the <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> transaction before its time lock expires, Bob can broadcast the first version and receive a full <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a>. This is one reason <a class="reference external" href="/en/developer-guide#term-micropayment-channel">micropayment channels</a> are best suited to small payments—if Alice’s Internet service goes out for a few hours near the time lock expiry, she could be cheated out of her payment.</p>
<p>Transaction malleability, discussed above in the Transactions section, is another reason to limit the value of <a class="reference external" href="/en/developer-guide#term-micropayment-channel">micropayment channels</a>. If someone uses transaction malleability to break the link between the two transactions, Alice could hold Bob’s 100 millibitcoins hostage even if she hadn’t done any work.</p>
<p>For larger payments, Bitcoin transaction fees are very low as a percentage of the total transaction value, so it makes more sense to protect payments with immediately-broadcast separate transactions.</p>
<p><strong>Resource:</strong> The <a class="reference external" href="http://bitcoinj.github.io">bitcoinj</a> Java library provides a complete set of micropayment functions, an example implementation, and <a class="reference external" href="https://bitcoinj.github.io/working-with-micropayments">a tutorial</a> all under an Apache license.</p>
</div>
<div class="section" id="coinjoin">
<h2>CoinJoin<a class="headerlink" href="#coinjoin" title="Permalink to this headline">¶</a></h2>
<p>Alice is concerned about her privacy. She knows every transaction gets added to the public block chain, so when Bob and Charlie pay her, they can each easily track those satoshis to learn what Bitcoin addresses she pays, how much she pays them, and possibly how many satoshis she has left.</p>
<p>Alice isn’t a criminal, she just wants plausible deniability about where she has spent her satoshis and how many she has left, so she starts up the Tor anonymity service on her computer and logs into an IRC chatroom as “AnonGirl.”</p>
<p>Also in the chatroom are “Nemo” and “Neminem.” They collectively agree to transfer satoshis between each other so no one besides them can reliably determine who controls which satoshis. But they’re faced with a dilemma: who transfers their satoshis to one of the other two pseudonymous persons first? The CoinJoin-style contract, shown in the illustration below, makes this decision easy: they create a single transaction which does all of the spending simultaneously, ensuring none of them can steal the others’ satoshis.</p>
<div class="figure" id="id2">
<img alt="Example CoinJoin Transaction" src="../_images/en-coinjoin.svg" /><p class="caption"><span class="caption-text">Example CoinJoin Transaction</span></p>
</div>
<p>Each contributor looks through their collection of Unspent Transaction Outputs (UTXOs) for 100 millibitcoins they can spend. They then each generate a brand new public key and give UTXO details and pubkey hashes to the facilitator. In this case, the facilitator is AnonGirl; she creates a transaction spending each of the UTXOs to three equally-sized outputs. One output goes to each of the contributors’ pubkey hashes.</p>
<p>AnonGirl then signs her inputs using <code class="docutils literal notranslate"><span class="pre">SIGHASH_ALL</span></code> to ensure nobody can change the input or output details. She gives the partially-signed transaction to Nemo who signs his inputs the same way and passes it to Neminem, who also signs it the same way. Neminem then broadcasts the transaction to the Bitcoin <a class="reference external" href="/en/developer-guide#term-network">peer-to-peer network</a>, mixing all of the millibitcoins in a single transaction.</p>
<p>As you can see in the illustration, there’s no way for anyone besides AnonGirl, Nemo, and Neminem to confidently determine who received which output, so they can each spend their output with plausible deniability.</p>
<p>Now when Bob or Charlie try to track Alice’s transactions through the block chain, they’ll also see transactions made by Nemo and Neminem. If Alice does a few more CoinJoins, Bob and Charlie might have to guess which transactions made by dozens or hundreds of people were actually made by Alice.</p>
<p>The complete history of Alice’s satoshis is still in the block chain, so a determined investigator could talk to the people AnonGirl CoinJoined with to find out the ultimate origin of her satoshis and possibly reveal AnonGirl as Alice. But against anyone casually browsing block chain history, Alice gains plausible deniability.</p>
<p>The CoinJoin technique described above costs the participants a small amount of satoshis to pay the transaction fee. An alternative technique, purchaser CoinJoin, can actually save them satoshis and improve their privacy at the same time.</p>
<p>AnonGirl waits in the IRC chatroom until she wants to make a purchase. She announces her intention to spend satoshis and waits until someone else wants to make a purchase, likely from a different merchant. Then they combine their inputs the same way as before but set the outputs to the separate merchant addresses so nobody will be able to figure out solely from block chain history which one of them bought what from the merchants.</p>
<p>Since they would’ve had to pay a transaction fee to make their purchases anyway, AnonGirl and her co-spenders don’t pay anything extra—but because they reduced overhead by combining multiple transactions, saving bytes, they may be able to pay a smaller aggregate transaction fee, saving each one of them a tiny amount of satoshis.</p>
<p><strong>Current Working Implementations:</strong> As of today, in 2018, <a class="reference external" href="https://github.com/JoinMarket-Org/">JoinMarket</a> and <a class="reference external" href="http://wasabiwallet.io">Wasabi Wallet</a> are the operational CoinJoin implementations for Bitcoin.</p>
<p>JoinMarket style CoinJoins differ from the above described scheme by splitting the participants into two sections: market makers and market takers. Market makers are publishing their CoinJoin intentions to an IRC room and waiting for market takers to take their offers. When a taker comes along, it selects a set of makers and creates a shared transaction with them, while also paying a small fee. Unlike the above described scheme, this happens automatically.</p>
<p>Wasabi Wallet style CoinJoins are called Chaumian CoinJoins. It employs a CoinJoin coordinator, where various peers can register. When the pre-defined number of participants registered, a CoinJoin-round kicks in. In this scheme Chaumian Blind Signatures are utilized to prevent the coordinator and the peers from learning which outputs correspond to which inputs. An example for Chaumian CoinJoin is the following transaction: <a class="reference external" href="https://www.smartbit.com.au/tx/8fee07b90f26e85e22e87da13e1618cd9eeaf98f3f3774273c9307cd40ff98e8">8fee07b90f26e85e22e87da13e1618cd9eeaf98f3f3774273c9307cd40ff98e8</a></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="wallets.html" class="btn btn-neutral float-right" title="Wallets" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="transactions.html" class="btn btn-neutral float-left" title="Transactions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Bitcoin.org

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>