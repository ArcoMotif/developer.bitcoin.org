

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Payment Processing &mdash; Bitcoin  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Operating Modes" href="operating_modes.html" />
    <link rel="prev" title="Wallets" href="wallets.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/bitcoin-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="block_chain.html">Block Chain</a></li>
<li class="toctree-l2"><a class="reference internal" href="transactions.html">Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="contracts.html">Contracts</a></li>
<li class="toctree-l2"><a class="reference internal" href="wallets.html">Wallets</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Payment Processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pricing-orders">Pricing Orders</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requesting-payments">Requesting Payments</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#plain-text">Plain Text</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bitcoin-uri">bitcoin: URI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#qr-codes">QR Codes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#payment-protocol">Payment Protocol</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#verifying-payment">Verifying Payment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#issuing-refunds">Issuing Refunds</a></li>
<li class="toctree-l3"><a class="reference internal" href="#disbursing-income-limiting-forex-risk">Disbursing Income (Limiting Forex Risk)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#merge-avoidance">Merge Avoidance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#last-in-first-out-lifo">Last In, First Out (LIFO)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#first-in-first-out-fifo">First In, First Out (FIFO)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#rebilling-recurring-payments">Rebilling Recurring Payments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="operating_modes.html">Operating Modes</a></li>
<li class="toctree-l2"><a class="reference internal" href="p2p_network.html">P2P Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="mining.html">Mining</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Bitcoin</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Developer Guides</a> &raquo;</li>
        
      <li>Payment Processing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/cornelius/bitcoin-dev-docs/blob/master/devguide/payment_processing.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="payment-processing">
<h1>Payment Processing<a class="headerlink" href="#payment-processing" title="Permalink to this headline">¶</a></h1>
<p>Payment processing encompasses the steps spenders and receivers perform to make and accept payments in exchange for products or services. The basic steps have not changed since the dawn of commerce, but the technology has.</p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This section will explain how receivers and spenders can, respectively, request and make payments using Bitcoin—and how they can deal with complications such as <a class="reference external" href="/en/developer-guide#issuing-refunds">refunds</a> and <a class="reference external" href="/en/developer-guide#rebilling-recurring-payments">recurrent rebilling</a>.</p>
<div class="figure" id="id1">
<img alt="Bitcoin Payment Processing" src="../_images/en-payment-processing.svg" /><p class="caption"><span class="caption-text">Bitcoin Payment Processing</span></p>
</div>
<p>The figure above illustrates payment processing using Bitcoin from a receiver’s perspective, starting with a new order. The following subsections will each address the three common steps and the three occasional or optional steps.</p>
<p>It is worth mentioning that each of these steps can be outsourced by using third party APIs and services.</p>
</div>
<div class="section" id="pricing-orders">
<h2>Pricing Orders<a class="headerlink" href="#pricing-orders" title="Permalink to this headline">¶</a></h2>
<p>Because of exchange rate variability between satoshis and national currencies (<a class="reference external" href="/en/developer-guide#term-fiat">fiat</a>), many Bitcoin orders are priced in <a class="reference external" href="/en/developer-guide#term-fiat">fiat</a> but paid in satoshis, necessitating a price conversion.</p>
<p>Exchange rate data is widely available through HTTP-based APIs provided by currency exchanges. Several organizations also aggregate data from multiple exchanges to create index prices, which are also available using HTTP-based APIs.</p>
<p>Any applications which automatically calculate order totals using exchange rate data must take steps to ensure the price quoted reflects the current general market value of satoshis, or the applications could accept too few satoshis for the product or service being sold. Alternatively, they could ask for too many satoshis, driving away potential spenders.</p>
<p>To minimize problems, your applications may want to collect data from at least two separate sources and compare them to see how much they differ. If the difference is substantial, your applications can enter a safe mode until a human is able to evaluate the situation.</p>
<p>You may also want to program your applications to enter a safe mode if exchange rates are rapidly increasing or decreasing, indicating a possible problem in the Bitcoin market which could make it difficult to spend any satoshis received today.</p>
<p>Exchange rates lie outside the control of Bitcoin and related technologies, so there are no new or planned technologies which will make it significantly easier for your program to correctly convert order totals from <a class="reference external" href="/en/developer-guide#term-fiat">fiat</a> into satoshis.</p>
<p>Because the exchange rate fluctuates over time, order totals pegged to <a class="reference external" href="/en/developer-guide#term-fiat">fiat</a> must expire to prevent spenders from delaying payment in the hope that satoshis will drop in price. Most widely-used payment processing systems currently expire their invoices after 10 to 20 minutes.</p>
<p>Shorter expiration periods increase the chance the invoice will expire before payment is received, possibly necessitating manual intervention to request an additional payment or to issue a <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a>. Longer expiration periods increase the chance that the exchange rate will fluctuate a significant amount before payment is received.</p>
</div>
<div class="section" id="requesting-payments">
<h2>Requesting Payments<a class="headerlink" href="#requesting-payments" title="Permalink to this headline">¶</a></h2>
<p>Before requesting payment, your application must create a Bitcoin address, or acquire an address from another program such as Bitcoin Core. Bitcoin addresses are described in detail in the <a class="reference external" href="/en/transactions-guide">Transactions</a> guide. Also described in that section are two important reasons to avoid using an address more than once—but a third reason applies especially to payment requests:</p>
<p>Using a separate address for each incoming payment makes it trivial to determine which customers have paid their payment requests. Your applications need only track the association between a particular payment request and the address used in it, and then scan the block chain for transactions matching that address.</p>
<p>The next subsections will describe in detail the following four compatible ways to give the spender the address and amount to be paid. For increased convenience and compatibility, providing all of these options in your payment requests is recommended.</p>
<ol class="arabic simple">
<li>All wallet software lets its users paste in or manually enter an address and amount into a payment screen. This is, of course, inconvenient—but it makes an effective fallback option.</li>
<li>Almost all desktop wallets can associate with <a class="reference external" href="/en/developer-guide#term-bitcoin-uri">“bitcoin:” URIs</a>, so spenders can click a link to pre-fill the payment screen. This also works with many mobile wallets, but it generally does not work with web-based wallets unless the spender installs a browser extension or manually configures a URI handler.</li>
<li>Most mobile wallets support scanning <a class="reference external" href="/en/developer-guide#term-bitcoin-uri">“bitcoin:” URIs</a> encoded in a QR code, and almost all wallets can display them for accepting payment. While also handy for online orders, QR Codes are especially useful for in-person purchases.</li>
<li>Recent wallet updates add support for the new payment protocol providing increased security, authentication of a receiver’s identity using <a class="reference external" href="https://en.wikipedia.org/wiki/X.509">X.509</a> certificates, and other important features such as <a class="reference external" href="/en/developer-guide#issuing-refunds">refunds</a>.</li>
</ol>
<p><img alt="Warning icon" src="../_images/icon_warning.svg" /> <strong>Warning:</strong> Special care must be taken to avoid the theft of incoming payments. In particular, private keys should not be stored on web servers, and payment requests should be sent over HTTPS or other secure methods to prevent <a class="reference external" href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle</a> attacks from replacing your Bitcoin address with the attacker’s address.</p>
<div class="section" id="plain-text">
<h3>Plain Text<a class="headerlink" href="#plain-text" title="Permalink to this headline">¶</a></h3>
<p>To specify an amount directly for copying and pasting, you must provide the address, the amount, and the denomination. An expiration time for the offer may also be specified. For example:</p>
<p>(Note: all examples in this section use testnet addresses.)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Pay</span><span class="p">:</span> <span class="n">mjSk1Ny9spzU2fouzYgLqGUD8U41iR35QN</span>
<span class="n">Amount</span><span class="p">:</span> <span class="mi">100</span> <span class="n">BTC</span>
<span class="n">You</span> <span class="n">must</span> <span class="n">pay</span> <span class="n">by</span><span class="p">:</span> <span class="mi">2014</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">01</span> <span class="n">at</span> <span class="mi">23</span><span class="p">:</span><span class="mi">00</span> <span class="n">UTC</span>
</pre></div>
</div>
<p>Indicating the denomination is critical. As of this writing, popular Bitcoin wallet software defaults to denominating amounts in either bitcoins (BTC) , millibitcoins (mBTC) or microbitcoins (uBTC, “bits”). Choosing between each unit is widely supported, but other software also lets its users select denomination amounts from some preselected (e.g.&nbsp;Table below) or all <a class="reference external" href="https://en.bitcoin.it/wiki/Units">standard 8 decimal places</a>:</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Bitcoins</th>
<th class="head">Unit (Abbreviation)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1.0</td>
<td>bitcoin (BTC)</td>
</tr>
<tr class="row-odd"><td>0.01</td>
<td>bitcent (cBTC)</td>
</tr>
<tr class="row-even"><td>0.001</td>
<td>millibitcoin (mBTC)</td>
</tr>
<tr class="row-odd"><td>0.000001</td>
<td>microbitcoin (uBTC, “bits”)</td>
</tr>
<tr class="row-even"><td>0.0000001</td>
<td>finney</td>
</tr>
<tr class="row-odd"><td>0.00000001</td>
<td>satoshi</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="bitcoin-uri">
<h3>bitcoin: URI<a class="headerlink" href="#bitcoin-uri" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">`bitcoin:</span></code> URI &lt;/en/developer-guide#term-bitcoin-uri&gt;`__ scheme defined in <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0021.mediawiki">BIP21</a> eliminates denomination confusion and saves the spender from copying and pasting two separate values. It also lets the payment request provide some additional information to the spender. An example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>bitcoin:mjSk1Ny9spzU2fouzYgLqGUD8U41iR35QN?amount=100
</pre></div>
</div>
<p>Only the address is required, and if it is the only thing specified, wallets will pre-fill a payment request with it and let the spender enter an amount. The amount specified is always in decimal bitcoins (BTC).</p>
<p>Two other parameters are widely supported. The <a class="reference external" href="/en/developer-guide#term-label">“label”</a> parameter is generally used to provide wallet software with the recipient’s name. The <a class="reference external" href="/en/developer-guide#term-message">“message”</a> parameter is generally used to describe the payment request to the spender. Both the label and the message are commonly stored by the spender’s wallet software—but they are never added to the actual transaction, so other Bitcoin users cannot see them. Both the label and the message must be <a class="reference external" href="https://tools.ietf.org/html/rfc3986">URI encoded</a>.</p>
<p>All four parameters used together, with appropriate URI encoding, can be seen in the line-wrapped example below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>bitcoin:mjSk1Ny9spzU2fouzYgLqGUD8U41iR35QN\
?amount=0.10\
&amp;label=Example+Merchant\
&amp;message=Order+of+flowers+%26+chocolates
</pre></div>
</div>
<p>The URI scheme can be extended, as will be seen in the payment protocol section below, with both new optional and required parameters. As of this writing, the only widely-used parameter besides the four described above is the payment protocol’s <a class="reference external" href="/en/developer-guide#term-r-parameter">“r”</a> parameter.</p>
<p>Programs accepting URIs in any form must ask the user for permission before paying unless the user has explicitly disabled prompting (as might be the case for micropayments).</p>
</div>
<div class="section" id="qr-codes">
<h3>QR Codes<a class="headerlink" href="#qr-codes" title="Permalink to this headline">¶</a></h3>
<p>QR codes are a popular way to exchange <a class="reference external" href="/en/developer-guide#term-bitcoin-uri">“bitcoin:” URIs</a> in person, in images, or in videos. Most mobile Bitcoin wallet apps, and some desktop wallets, support scanning QR codes to pre-fill their payment screens.</p>
<p>The figure below shows the same <a class="reference external" href="/en/developer-guide#term-bitcoin-uri">“bitcoin:” URI</a> code encoded as four different <a class="reference external" href="/en/developer-guide#term-uri-qr-code">Bitcoin QR codes</a> at four different error correction levels. The QR code can include the <a class="reference external" href="/en/developer-guide#term-label">“label”</a> and <a class="reference external" href="/en/developer-guide#term-message">“message”</a> parameters—and any other optional parameters—but they were omitted here to keep the QR code small and easy to scan with unsteady or low-resolution mobile cameras.</p>
<div class="figure" id="id2">
<img alt="Bitcoin QR Codes" src="../_images/en-qr-code.svg" /><p class="caption"><span class="caption-text">Bitcoin QR Codes</span></p>
</div>
<p>The error correction is combined with a checksum to ensure the <a class="reference external" href="/en/developer-guide#term-uri-qr-code">Bitcoin QR code</a> cannot be successfully decoded with data missing or accidentally altered, so your applications should choose the appropriate level of error correction based on the space you have available to display the code. Low-level damage correction works well when space is limited, and quartile-level damage correction helps ensure fast scanning when displayed on high-resolution screens.</p>
</div>
<div class="section" id="payment-protocol">
<h3>Payment Protocol<a class="headerlink" href="#payment-protocol" title="Permalink to this headline">¶</a></h3>
<p><img alt="Warning icon" src="../_images/icon_warning.svg" /> <strong>Warning:</strong> The payment protocol is considered to be deprecated and will be removed in a later version of Bitcoin Core. The protocol has multiple security design flaws and implementation flaws in some wallets. Users will begin receiving deprecation warnings in Bitcoin Core version 0.18 when using <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki">BIP70</a> URI’s. Merchants should transition away from <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki">BIP70</a> to more secure options such as <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0021.mediawiki">BIP21</a>. Merchants should never require <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki">BIP70</a> payments and should provide <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0021.mediawiki">BIP21</a> fallbacks.</p>
<p>Bitcoin Core 0.9 supports the new <a class="reference external" href="../reference/glossary.html#payment-protocol">payment protocol</a>. The payment protocol adds many important features to payment requests:</p>
<ul class="simple">
<li>Supports <a class="reference external" href="https://en.wikipedia.org/wiki/X.509">X.509</a> certificates and SSL encryption to verify receivers’ identity and help prevent <a class="reference external" href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle</a> attacks.</li>
<li>Provides more detail about the requested payment to spenders.</li>
<li>Allows spenders to submit transactions directly to receivers without going through the <a class="reference external" href="/en/developer-guide#term-network">peer-to-peer network</a>. This can speed up payment processing and work with planned features such as child-pays-for-parent transaction fees and offline NFC or Bluetooth-based payments.</li>
</ul>
<p>Instead of being asked to pay a meaningless address, such as “mjSk1Ny9spzU2fouzYgLqGUD8U41iR35QN”, spenders are asked to pay the Common Name (CN) description from the receiver’s <a class="reference external" href="https://en.wikipedia.org/wiki/X.509">X.509</a> certificate, such as “www.bitcoin.org”.</p>
<p>To request payment using the payment protocol, you use an extended (but backwards-compatible) <a class="reference external" href="/en/developer-guide#term-bitcoin-uri">“bitcoin:” URI</a>. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>bitcoin:mjSk1Ny9spzU2fouzYgLqGUD8U41iR35QN\
?amount=0.10\
&amp;label=Example+Merchant\
&amp;message=Order+of+flowers+%26+chocolates\
&amp;r=https://example.com/pay/mjSk1Ny9spzU2fouzYgLqGUD8U41iR35QN
</pre></div>
</div>
<p>None of the parameters provided above, except <a class="reference external" href="/en/developer-guide#term-r-parameter">“r”</a>, are required for the payment protocol—but your applications may include them for backwards compatibility with wallet programs which don’t yet handle the payment protocol.</p>
<p>The <a class="reference external" href="/en/developer-guide#term-r-parameter">“r”</a> parameter tells payment-protocol-aware wallet programs to ignore the other parameters and fetch a <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> from the URL provided. The browser, QR code reader, or other program processing the URI opens the spender’s Bitcoin wallet program on the URI.</p>
<div class="figure" id="id3">
<img alt="BIP70 Payment Protocol" src="../_images/en-payment-protocol.svg" /><p class="caption"><span class="caption-text">BIP70 Payment Protocol</span></p>
</div>
<p>The Payment Protocol is described in depth in <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki">BIP70</a>, <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0071.mediawiki">BIP71</a>, and <a class="reference external" href="https://github.com/bitcoin/bips/blob/master/bip-0072.mediawiki">BIP72</a>. An example CGI program and description of all the parameters which can be used in the Payment Protocol is provided in the Developer Examples <a class="reference external" href="/en/developer-examples#payment-protocol">Payment Protocol</a> subsection. In this subsection, we will briefly describe in story format how the Payment Protocol is typically used.</p>
<p>Charlie, the client, is shopping on a website run by Bob, the businessman. Charlie adds a few items to his shopping cart and clicks the “Checkout With Bitcoin” button.</p>
<p>Bob’s server automatically adds the following information to its invoice database:</p>
<ul class="simple">
<li>The details of Charlie’s order, including items ordered and shipping address.</li>
<li>An order total in satoshis, perhaps created by converting prices in <a class="reference external" href="/en/developer-guide#term-fiat">fiat</a> to prices in satoshis.</li>
<li>An expiration time when that total will no longer be acceptable.</li>
<li>A pubkey script to which Charlie should send payment. Typically this will be a P2PKH or P2SH pubkey script containing a unique (never before used) <a class="reference external" href="http://www.secg.org/sec2-v2.pdf">secp256k1</a> public key.</li>
</ul>
<p>After adding all that information to the database, Bob’s server displays a <a class="reference external" href="/en/developer-guide#term-bitcoin-uri">“bitcoin:” URI</a> for Charlie to click to pay.</p>
<p>Charlie clicks on the <a class="reference external" href="/en/developer-guide#term-bitcoin-uri">“bitcoin:” URI</a> in his browser. His browser’s URI handler sends the URI to his wallet program. The wallet is aware of the Payment Protocol, so it parses the <a class="reference external" href="/en/developer-guide#term-r-parameter">“r”</a> parameter and sends an HTTP GET to that URL looking for a <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> message.</p>
<p>The <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> message returned may include private information, such as Charlie’s mailing address, but the wallet must be able to access it without using prior authentication, such as HTTP cookies, so a publicly accessible HTTPS URL with a guess-resistant part is typically used. The unique public key created for the payment request can be used to create a unique identifier. This is why, in the example URI above, the <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> URL contains the P2PKH address: <code class="docutils literal notranslate"><span class="pre">https://example.com/pay/mjSk1Ny9spzU2fouzYgLqGUD8U41iR35QN</span></code></p>
<p>After receiving the HTTP GET to the URL above, the <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a>-generating CGI program on Bob’s webserver takes the unique identifier from the URL and looks up the corresponding details in the database. It then creates a <a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a> message with the following information:</p>
<ul class="simple">
<li>The amount of the order in satoshis and the pubkey script to be paid.</li>
<li>A memo containing the list of items ordered, so Charlie knows what he’s paying for. It may also include Charlie’s mailing address so he can double-check it.</li>
<li>The time the <a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a> message was created plus the time it expires.</li>
<li>A URL to which Charlie’s wallet should send its completed transaction.</li>
</ul>
<p>That <a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a> message is put inside a <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> message. The payment request lets Bob’s server sign the entire Request with the server’s <a class="reference external" href="https://en.wikipedia.org/wiki/X.509">X.509</a> SSL certificate. (The Payment Protocol has been designed to allow other signing methods in the future.) Bob’s server sends the payment request to Charlie’s wallet in the reply to the HTTP GET.</p>
<div class="figure" id="id4">
<img alt="Bitcoin Core Showing Validated Payment Request" src="../_images/en-btcc-payment-request.png" />
<p class="caption"><span class="caption-text">Bitcoin Core Showing Validated Payment Request</span></p>
</div>
<p>Charlie’s wallet receives the <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> message, checks its signature, and then displays the details from the <a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a> message to Charlie. Charlie agrees to pay, so the wallet constructs a payment to the pubkey script Bob’s server provided. Unlike a traditional Bitcoin payment, Charlie’s wallet doesn’t necessarily automatically broadcast this payment to the <a class="reference external" href="/en/developer-guide#term-network">network</a>. Instead, the wallet constructs a Payment message and sends it to the URL provided in the <a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a> message as an HTTP POST. Among other things, the Payment message contains:</p>
<ul class="simple">
<li>The signed transaction in which Charlie pays Bob.</li>
<li>An optional memo Charlie can send to Bob. (There’s no guarantee that Bob will read it.)</li>
<li>A <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> address (pubkey script) which Bob can pay if he needs to return some or all of Charlie’s satoshis.</li>
</ul>
<p>Bob’s server receives the Payment message, verifies the transaction pays the requested amount to the address provided, and then broadcasts the transaction to the <a class="reference external" href="/en/developer-guide#term-network">network</a>. It also replies to the HTTP POSTed Payment message with a PaymentACK message, which includes an optional memo from Bob’s server thanking Charlie for his patronage and providing other information about the order, such as the expected arrival date.</p>
<p>Charlie’s wallet sees the PaymentACK and tells Charlie that the payment has been sent. The PaymentACK doesn’t mean that Bob has verified Charlie’s payment—see the Verifying Payment subsection below—but it does mean that Charlie can go do something else while the transaction gets confirmed. After Bob’s server verifies from the block chain that Charlie’s transaction has been suitably confirmed, it authorizes shipping Charlie’s order.</p>
<p>In the case of a dispute, Charlie can generate a cryptographically proven <a class="reference external" href="/en/developer-guide#term-receipt">receipt</a> out of the various signed or otherwise-proven information.</p>
<ul class="simple">
<li>The <a class="reference external" href="/en/developer-examples#term-paymentdetails">PaymentDetails</a> message signed by Bob’s webserver proves Charlie received an invoice to pay a specified pubkey script for a specified number of satoshis for goods specified in the memo field.</li>
<li>The Bitcoin block chain can prove that the pubkey script specified by Bob was paid the specified number of satoshis.</li>
</ul>
<p>If a <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> needs to be issued, Bob’s server can safely pay the <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a>-to pubkey script provided by Charlie. See the <a class="reference external" href="/en/developer-guide#issuing-refunds">Refunds</a> section below for more details.</p>
</div>
</div>
<div class="section" id="verifying-payment">
<h2>Verifying Payment<a class="headerlink" href="#verifying-payment" title="Permalink to this headline">¶</a></h2>
<p>As explained in the <a class="reference external" href="/en/developer-guide#transactions">Transactions</a> and <a class="reference external" href="/en/developer-guide#block-chain">Block Chain</a> sections, broadcasting a transaction to the <a class="reference external" href="/en/developer-guide#term-network">network</a> doesn’t ensure that the receiver gets paid. A malicious spender can create one transaction that pays the receiver and a second one that pays the same input back to himself. Only one of these transactions will be added to the block chain, and nobody can say for sure which one it will be.</p>
<p>Two or more transactions spending the same input are commonly referred to as a <a class="reference external" href="../reference/glossary.html#double-spend">double spend</a>.</p>
<p>Once the transaction is included in a block, double spends are impossible without modifying block chain history to replace the transaction, which is quite difficult. Using this system, the Bitcoin protocol can give each of your transactions an updating confidence score based on the number of blocks which would need to be modified to replace a transaction. For each block, the transaction gains one <a class="reference external" href="../reference/glossary.html#confirmation-score">confirmation</a>. Since modifying blocks is quite difficult, higher confirmation scores indicate greater protection.</p>
<p><strong>0 confirmations</strong>: The transaction has been broadcast but is still not included in any block. Zero confirmation transactions (unconfirmed transactions) should generally not be trusted without risk analysis. Although miners usually confirm the first transaction they receive, fraudsters may be able to manipulate the <a class="reference external" href="/en/developer-guide#term-network">network</a> into including their version of a transaction.</p>
<p><strong>1 confirmation</strong>: The transaction is included in the latest block and double-spend risk decreases dramatically. Transactions which pay sufficient transaction fees need 10 minutes on average to receive one confirmation. However, the most recent block gets replaced fairly often by accident, so a double spend is still a real possibility.</p>
<p><strong>2 confirmations</strong>: The most recent block was chained to the block which includes the transaction. As of March 2014, two block replacements were exceedingly rare, and a two block replacement attack was impractical without expensive mining equipment.</p>
<p><strong>6 confirmations</strong>: The <a class="reference external" href="/en/developer-guide#term-network">network</a> has spent about an hour working to protect the transaction against double spends and the transaction is buried under six blocks. Even a reasonably lucky attacker would require a large percentage of the total <a class="reference external" href="/en/developer-guide#term-network">network</a> hashing power to replace six blocks. Although this number is somewhat arbitrary, software handling high-value transactions, or otherwise at risk for fraud, should wait for at least six confirmations before treating a payment as accepted.</p>
<p>Bitcoin Core provides several <a class="reference external" href="/en/developer-reference#remote-procedure-calls-rpcs">RPCs</a> which can provide your program with the confirmation score for transactions in your wallet or arbitrary transactions. For example, the <a class="reference external" href="/en/developer-reference#listunspent">“listunspent” RPC</a> provides an array of every satoshi you can spend along with its confirmation score.</p>
<p>Although confirmations provide excellent double-spend protection most of the time, there are at least three cases where double-spend risk analysis can be required:</p>
<ol class="arabic simple">
<li>In the case when the program or its user cannot wait for a confirmation and wants to accept unconfirmed payments.</li>
<li>In the case when the program or its user is accepting high value transactions and cannot wait for at least six confirmations or more.</li>
<li>In the case of an implementation bug or prolonged attack against Bitcoin which makes the system less reliable than expected.</li>
</ol>
<p>An interesting source of double-spend risk analysis can be acquired by connecting to large numbers of Bitcoin peers to track how transactions and blocks differ from each other. Some third-party APIs can provide you with this type of service.</p>
<p>For example, unconfirmed transactions can be compared among all connected peers to see if any UTXO is used in multiple unconfirmed transactions, indicating a double-spend attempt, in which case the payment can be refused until it is confirmed. Transactions can also be ranked by their transaction fee to estimate the amount of time until they’re added to a block.</p>
<p>Another example could be to detect a fork when multiple peers report differing block header hashes at the same block height. Your program can go into a safe mode if the fork extends for more than two blocks, indicating a possible problem with the block chain. For more details, see the <a class="reference external" href="/en/developer-guide#detecting-forks">Detecting Forks subsection</a>.</p>
<p>Another good source of double-spend protection can be human intelligence. For example, fraudsters may act differently from legitimate customers, letting savvy merchants manually flag them as high risk. Your program can provide a safe mode which stops automatic payment acceptance on a global or per-customer basis.</p>
</div>
<div class="section" id="issuing-refunds">
<h2>Issuing Refunds<a class="headerlink" href="#issuing-refunds" title="Permalink to this headline">¶</a></h2>
<p>Occasionally receivers using your applications will need to issue <a class="reference external" href="/en/developer-guide#issuing-refunds">refunds</a>. The obvious way to do that, which is very unsafe, is simply to return the satoshis to the pubkey script from which they came. For example:</p>
<ul class="simple">
<li>Alice wants to buy a widget from Bob, so Bob gives Alice a price and Bitcoin address.</li>
<li>Alice opens her wallet program and sends some satoshis to that address. Her wallet program automatically chooses to spend those satoshis from one of its unspent outputs, an output corresponding to the Bitcoin address mjSk1Ny9spzU2fouzYgLqGUD8U41iR35QN.</li>
<li>Bob discovers Alice paid too many satoshis. Being an honest fellow, Bob <a class="reference external" href="/en/developer-guide#issuing-refunds">refunds</a> the extra satoshis to the mjSk… address.</li>
</ul>
<p>This seems like it should work, but Alice is using a centralized multi-user web wallet which doesn’t give <a class="reference external" href="/en/developer-guide#term-unique-address">unique addresses</a> to each user, so it has no way to know that Bob’s <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> is meant for Alice. Now the <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> is a unintentional donation to the company behind the centralized wallet, unless Alice opens a support ticket and proves those satoshis were meant for her.</p>
<p>This leaves receivers only two correct ways to issue <a class="reference external" href="/en/developer-guide#issuing-refunds">refunds</a>:</p>
<ul class="simple">
<li>If an address was copy-and-pasted or a basic <a class="reference external" href="/en/developer-guide#term-bitcoin-uri">“bitcoin:” URI</a> was used, contact the spender directly and ask them to provide a <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> address.</li>
<li>If the payment protocol was used, send the <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> to the output listed in the <code class="docutils literal notranslate"><span class="pre">refund_to</span></code> field of the Payment message.</li>
</ul>
<p>Note: it would be wise to contact the spender directly if the <a class="reference external" href="/en/developer-guide#issuing-refunds">refund</a> is being issued a long time after the original payment was made. This allows you to ensure the user still has access to the key or keys for the <code class="docutils literal notranslate"><span class="pre">refund_to</span></code> address.</p>
</div>
<div class="section" id="disbursing-income-limiting-forex-risk">
<h2>Disbursing Income (Limiting Forex Risk)<a class="headerlink" href="#disbursing-income-limiting-forex-risk" title="Permalink to this headline">¶</a></h2>
<p>Many receivers worry that their satoshis will be less valuable in the future than they are now, called foreign exchange (forex) risk. To limit forex risk, many receivers choose to disburse newly-acquired payments soon after they’re received.</p>
<p>If your application provides this business logic, it will need to choose which outputs to spend first. There are a few different algorithms which can lead to different results.</p>
<ul class="simple">
<li>A <a class="reference external" href="/en/developer-guide#term-merge-avoidance">merge avoidance</a> algorithm makes it harder for outsiders looking at block chain data to figure out how many satoshis the receiver has earned, spent, and saved.</li>
<li>A last-in-first-out (LIFO) algorithm spends newly acquired satoshis while there’s still double spend risk, possibly pushing that risk on to others. This can be good for the receiver’s balance sheet but possibly bad for their reputation.</li>
<li>A first-in-first-out (FIFO) algorithm spends the oldest satoshis first, which can help ensure that the receiver’s payments always confirm, although this has utility only in a few edge cases.</li>
</ul>
<div class="section" id="merge-avoidance">
<h3>Merge Avoidance<a class="headerlink" href="#merge-avoidance" title="Permalink to this headline">¶</a></h3>
<p>When a receiver receives satoshis in an output, the spender can track (in a crude way) how the receiver spends those satoshis. But the spender can’t automatically see other satoshis paid to the receiver by other spenders as long as the receiver uses <a class="reference external" href="/en/developer-guide#term-unique-address">unique addresses</a> for each transaction.</p>
<p>However, if the receiver spends satoshis from two different spenders in the same transaction, each of those spenders can see the other spender’s payment. This is called a <a class="reference external" href="/en/developer-guide#term-merge">merge</a>, and the more a receiver merges outputs, the easier it is for an outsider to track how many satoshis the receiver has earned, spent, and saved.</p>
<p><a class="reference external" href="/en/developer-guide#term-merge-avoidance">Merge avoidance</a> means trying to avoid spending unrelated outputs in the same transaction. For persons and businesses which want to keep their transaction data secret from other people, it can be an important strategy.</p>
<p>A crude <a class="reference external" href="/en/developer-guide#term-merge-avoidance">merge avoidance</a> strategy is to try to always pay with the smallest output you have which is larger than the amount being requested. For example, if you have four outputs holding, respectively, 100, 200, 500, and 900 satoshis, you would pay a bill for 300 satoshis with the 500-satoshi output. This way, as long as you have outputs larger than your bills, you avoid merging.</p>
<p>More advanced <a class="reference external" href="/en/developer-guide#term-merge-avoidance">merge avoidance</a> strategies largely depend on enhancements to the payment protocol which will allow payers to avoid merging by intelligently distributing their payments among multiple outputs provided by the receiver.</p>
</div>
<div class="section" id="last-in-first-out-lifo">
<h3>Last In, First Out (LIFO)<a class="headerlink" href="#last-in-first-out-lifo" title="Permalink to this headline">¶</a></h3>
<p>Outputs can be spent as soon as they’re received—even before they’re confirmed. Since recent outputs are at the greatest risk of being double-spent, spending them before older outputs allows the spender to hold on to older confirmed outputs which are much less likely to be double-spent.</p>
<p>There are two closely-related downsides to LIFO:</p>
<ul class="simple">
<li>If you spend an output from one unconfirmed transaction in a second transaction, the second transaction becomes invalid if transaction malleability changes the first transaction.</li>
<li>If you spend an output from one unconfirmed transaction in a second transaction and the first transaction’s output is successfully double spent to another output, the second transaction becomes invalid.</li>
</ul>
<p>In either of the above cases, the receiver of the second transaction will see the incoming transaction notification disappear or turn into an error message.</p>
<p>Because LIFO puts the recipient of secondary transactions in as much double-spend risk as the recipient of the primary transaction, they’re best used when the secondary recipient doesn’t care about the risk—such as an exchange or other service which is going to wait for six confirmations whether you spend old outputs or new outputs.</p>
<p>LIFO should not be used when the primary transaction recipient’s reputation might be at stake, such as when paying employees. In these cases, it’s better to wait for transactions to be fully verified (see the <a class="reference external" href="/en/developer-guide#verifying-payment">Verification subsection</a> above) before using them to make payments.</p>
</div>
<div class="section" id="first-in-first-out-fifo">
<h3>First In, First Out (FIFO)<a class="headerlink" href="#first-in-first-out-fifo" title="Permalink to this headline">¶</a></h3>
<p>The oldest outputs are the most reliable, as the longer it’s been since they were received, the more blocks would need to be modified to double spend them. However, after just a few blocks, a point of rapidly diminishing returns is reached. The <a class="reference external" href="https://bitcoin.org/en/bitcoin-paper">original Bitcoin paper</a> predicts the chance of an attacker being able to modify old blocks, assuming the attacker has 30% of the total <a class="reference external" href="/en/developer-guide#term-network">network</a> hashing power:</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="81%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Blocks</th>
<th class="head">Chance of successful modification</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>5</td>
<td>17.73523%</td>
</tr>
<tr class="row-odd"><td>10</td>
<td>4.16605%</td>
</tr>
<tr class="row-even"><td>15</td>
<td>1.01008%</td>
</tr>
<tr class="row-odd"><td>20</td>
<td>0.24804%</td>
</tr>
<tr class="row-even"><td>25</td>
<td>0.06132%</td>
</tr>
<tr class="row-odd"><td>30</td>
<td>0.01522%</td>
</tr>
<tr class="row-even"><td>35</td>
<td>0.00379%</td>
</tr>
<tr class="row-odd"><td>40</td>
<td>0.00095%</td>
</tr>
<tr class="row-even"><td>45</td>
<td>0.00024%</td>
</tr>
<tr class="row-odd"><td>50</td>
<td>0.00006%</td>
</tr>
</tbody>
</table>
<p>FIFO does have a small advantage when it comes to transaction fees, as older outputs may be eligible for inclusion in the 50,000 bytes set aside for no-fee-required high-priority transactions by miners running the default Bitcoin Core codebase. However, with transaction fees being so low, this is not a significant advantage.</p>
<p>The only practical use of FIFO is by receivers who spend all or most of their income within a few blocks, and who want to reduce the chance of their payments becoming accidentally invalid. For example, a receiver who holds each payment for six confirmations, and then spends 100% of <a class="reference external" href="/en/developer-guide#verifying-payment">verified payments</a> to vendors and a savings account on a bi-hourly schedule.</p>
</div>
</div>
<div class="section" id="rebilling-recurring-payments">
<h2>Rebilling Recurring Payments<a class="headerlink" href="#rebilling-recurring-payments" title="Permalink to this headline">¶</a></h2>
<p>Automated recurring payments are not possible with decentralized Bitcoin wallets. Even if a wallet supported automatically sending non-reversible payments on a regular schedule, the user would still need to start the program at the appointed time, or leave it running all the time unprotected by encryption.</p>
<p>This means automated recurring Bitcoin payments can only be made from a centralized server which handles satoshis on behalf of its spenders. In practice, receivers who want to set prices in <a class="reference external" href="/en/developer-guide#term-fiat">fiat</a> terms must also let the same centralized server choose the appropriate exchange rate.</p>
<p>Non-automated rebilling can be managed by the same mechanism used before credit-card recurring payments became common: contact the spender and ask them to pay again—for example, by sending them a <a class="reference external" href="/en/developer-examples#term-paymentrequest">PaymentRequest</a> <a class="reference external" href="/en/developer-guide#term-bitcoin-uri">“bitcoin:” URI</a> in an HTML email.</p>
<p>In the future, extensions to the payment protocol and new wallet features may allow some wallet programs to manage a list of recurring transactions. The spender will still need to start the program on a regular basis and authorize payment—but it should be easier and more secure for the spender than clicking an emailed invoice, increasing the chance receivers get paid on time.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="operating_modes.html" class="btn btn-neutral float-right" title="Operating Modes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="wallets.html" class="btn btn-neutral float-left" title="Wallets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Bitcoin.org

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>